name: CI/CD Pipeline

on: [push, pull_request, workflow_dispatch]

jobs:
  build:
    name: Build and Test (Ubuntu)
    runs-on: ubuntu-22.04
    timeout-minutes: 30

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Check C++ Code Style
        run: |
          echo "Installing clang-format..."
          sudo apt-get install -y clang-format >/dev/null || { echo "FAILED: clang-format install"; exit 1; }
          echo -n "Checking code style... "
          find src/ -name '*.cpp' -o -name '*.hpp' | xargs clang-format --dry-run --Werror || { echo "FAILED: Code style check"; exit 1; }
          find include/ -name '*.cpp' -o -name '*.hpp' | xargs clang-format --dry-run --Werror || { echo "FAILED: Code style check"; exit 1; }
          echo "OK"

      - name: Cache Dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.ccache
            build/_deps
          key: ${{ runner.os }}-${{ env.BUILD_TYPE }}-deps-${{ hashFiles('CMakeLists.txt') }}
          restore-keys: |
            ${{ runner.os }}-${{ env.BUILD_TYPE }}-deps-

      - name: Install System Dependencies
        run: |
          echo -n "Installing dependencies..."
          sudo apt-get update -qq || { echo "FAILED: apt update"; exit 1; }
          sudo apt-get install -y --no-install-recommends \
            build-essential \
            cmake \
            zlib1g-dev \
            libzstd-dev \
            libsnappy-dev \
            ccache >/dev/null || { echo "FAILED: Dependency install"; exit 1; }
          echo "OK"
